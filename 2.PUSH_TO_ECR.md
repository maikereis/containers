
# download
wget -O /tmp/containers-src.zip \
  https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/DEV-AWS-MO-ContainersRedux/downloads/containers-src.zip

# unzip
unzip /tmp/containers-src.zip -d /tmp

cd /tmp/first-container

docker build -t hello-world .

docker images --filter reference=hello-world

export AWS_REGION="us-east-1"
export REPO_NAME="my-repo"
export IMAGE_TAG="latest"

# create repository and get URI
REPO_URI=$(aws ecr create-repository \
  --repository-name "$REPO_NAME" \
  --region "$AWS_REGION" \
  --image-scanning-configuration scanOnPush=true \
  --encryption-configuration encryptionType=AES256 \
  --tags Key=Environment,Value=dev Key=ManagedBy,Value=script \
  --query "repository.repositoryUri" \
  --output text)

# set lifecycle policy to expire images older than 1 day
aws ecr put-lifecycle-policy \
    --repository-name "$REPO_NAME"
    --region "$AWS_REGION" \
    --lifecycle-policy-test '{
        "rules":[
            {
                "rulePriority":1,
                "description":"Expire images older than 1 day",
                "selection":{
                    "tagStatus":"any",
                    "countType":"sinceImagePushed",
                    "countUnit":"days",
                    "countNumber":1
                },
                "action":{
                    "type":"expire"
                }
            }
        ]

    }' &>/dev/null

# login on ECR
aws ecr get-login-password --region $AWS_REGION \
    | docker login \
    --username AWS \
    --password-stdin "$REPO_URI" 2>/dev/null

# tag and push image
docker tag hello-world:latest "$REPO_URI":latest && docker images
docker push "$REPO_URI":latest
