
### 1. Download Data

```bash
    wget -O /tmp/containers-src.zip \
    https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/DEV-AWS-MO-ContainersRedux/downloads/containers-src.zip
```

Unzip

```bash
unzip /tmp/containers-src.zip -d /tmp

cd /tmp/first-container
```


```bash
# Build a simple container
docker build -t hello-world .
```
```bash
# Check created image
docker images --filter reference=hello-world
```

### 2. Configure Environment

```bash
export AWS_REGION="us-east-1"
export REPO_NAME="my-repo"
export IMAGE_TAG="latest"
```

### 3. Create the repository

```bash
# Create repository and get URI
REPO_URI=$(aws ecr create-repository \
  --repository-name "$REPO_NAME" \
  --region "$AWS_REGION" \
  --image-scanning-configuration scanOnPush=true \
  --encryption-configuration encryptionType=AES256 \
  --tags Key=Environment,Value=dev Key=ManagedBy,Value=script \
  --query "repository.repositoryUri" \
  --output text)
```

Create an expiration policy

```bash
# Set lifecycle policy to expire images older than 1 day
aws ecr put-lifecycle-policy \
    --repository-name "$REPO_NAME"
    --region "$AWS_REGION" \
    --lifecycle-policy-test '{
        "rules":[
            {
                "rulePriority":1,
                "description":"Expire images older than 1 day",
                "selection":{
                    "tagStatus":"any",
                    "countType":"sinceImagePushed",
                    "countUnit":"days",
                    "countNumber":1
                },
                "action":{
                    "type":"expire"
                }
            }
        ]

    }' &>/dev/null
```

### 4. Login into ecr

```bash
# Login on ECR
aws ecr get-login-password --region $AWS_REGION \
    | docker login \
    --username AWS \
    --password-stdin "$REPO_URI" 2>/dev/null
```

### 5. Tag the container image and push to ECR

```bash
# tag and push image
docker tag hello-world:latest "$REPO_URI":latest && docker images
docker push "$REPO_URI":latest
```

## Cleanup

```bash
# Remove local image
docker rmi hello-world:latest
# Remove remote image
docker rmi "$REPO_URI":latest
```

Remove the repository

```bash
aws ecr delete-repository \
    --repository-name "$REPO_NAME" \
    --region "$AWS_REGION" \
    --force
```

```bash
# Logout from ECR
docker logout "$REPO_URI"
```